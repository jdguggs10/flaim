# Eval Trace + Full Worker Observability Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Capture and persist per-question trace artifacts from all four workers (`fantasy-mcp`, `espn-client`, `yahoo-client`, `auth-worker`) while filtering to only logs relevant to each eval question.

**Architecture:** Introduce a per-question `trace_id` generated by `flaim-eval`, propagate it end-to-end via headers through the gateway and downstream worker-to-worker calls, and emit structured JSON logs containing `trace_id`/`run_id`/`correlation_id` in every worker. Update log enrichment to query all four workers by `trace_id` first (deterministic), with bounded retry and optional re-enrichment for delayed indexing.

**Tech Stack:** TypeScript, Node 25 + `tsx`, OpenAI Responses API MCP tool calls, Cloudflare Workers Observability Telemetry API, Vitest in workers, Node test runner for `flaim-eval`.

---

### Task 1: Add Per-Question Trace Model In `flaim-eval`

**Files:**
- Modify: `../flaim-eval/src/types.ts`
- Modify: `../flaim-eval/src/runner.ts`
- Modify: `../flaim-eval/src/run.ts`
- Create: `../flaim-eval/src/trace.ts`
- Create: `../flaim-eval/src/__tests__/trace.test.ts`
- Modify: `../flaim-eval/package.json`

**Step 1: Write failing tests for trace ID generation and artifact shape**

```ts
import test from "node:test";
import assert from "node:assert/strict";
import { createTraceId } from "../trace.js";

test("createTraceId is deterministic format", () => {
  const id = createTraceId("who_is_on_my_roster", 0);
  assert.match(id, /^trace_who_is_on_my_roster_\d{3}$/);
});
```

**Step 2: Run tests to verify failure**

Run: `cd ../flaim-eval && node --import tsx --test src/__tests__/*.test.ts`
Expected: FAIL because `trace.ts` and exported helpers do not yet exist.

**Step 3: Implement minimal trace utilities + type additions**

- Add `trace_id` to `TraceArtifact`.
- Add helper to generate per-question trace ID.
- Ensure `run.ts` writes artifacts to `runs/<run_id>/<trace_id>/trace.json`.

**Step 4: Re-run tests + typecheck**

Run: `cd ../flaim-eval && node --import tsx --test src/__tests__/*.test.ts && npx tsc --noEmit`
Expected: PASS.

**Step 5: Commit**

```bash
cd ../flaim-eval
git add src/types.ts src/runner.ts src/run.ts src/trace.ts src/__tests__/trace.test.ts package.json
git commit -m "feat: add per-question trace ids and trace artifact layout"
```

---

### Task 2: Send Trace Headers On Every MCP Question

**Files:**
- Modify: `../flaim-eval/src/runner.ts`
- Modify: `../flaim-eval/src/types.ts`
- Create: `../flaim-eval/src/__tests__/runner-headers.test.ts`

**Step 1: Write failing test for MCP headers**

- Assert MCP tool headers include both:
  - `X-Flaim-Eval-Run`
  - `X-Flaim-Eval-Trace`

**Step 2: Run test to verify failure**

Run: `cd ../flaim-eval && node --import tsx --test src/__tests__/runner-headers.test.ts`
Expected: FAIL because only run header exists today.

**Step 3: Implement minimal header changes**

- Add `traceId` to runner config.
- Set `X-Flaim-Eval-Trace` in `openai.responses.create({...tools:[{headers}]})`.

**Step 4: Run tests + smoke one scenario**

Run: `cd ../flaim-eval && node --import tsx --test src/__tests__/runner-headers.test.ts && npm run eval who_is_on_my_roster`
Expected: PASS, eval run succeeds.

**Step 5: Commit**

```bash
cd ../flaim-eval
git add src/runner.ts src/types.ts src/__tests__/runner-headers.test.ts
git commit -m "feat: send per-question trace header to MCP requests"
```

---

### Task 3: Propagate Trace Headers Through Shared + Gateway

**Files:**
- Modify: `workers/shared/src/tracing.ts`
- Modify: `workers/shared/src/index.ts`
- Modify: `workers/fantasy-mcp/src/index.ts`
- Modify: `workers/fantasy-mcp/src/router.ts`
- Modify: `workers/fantasy-mcp/src/mcp/tools.ts`
- Modify: `workers/fantasy-mcp/src/__tests__/router.test.ts`

**Step 1: Write failing gateway propagation test**

- Extend `router.test.ts` to assert downstream request headers include:
  - `X-Flaim-Eval-Run`
  - `X-Flaim-Eval-Trace`

**Step 2: Run test to verify failure**

Run: `cd workers/fantasy-mcp && npm test -- router.test.ts`
Expected: FAIL because only correlation header is forwarded.

**Step 3: Implement shared helpers and propagation**

- Add constants + helpers:
  - `EVAL_RUN_HEADER`
  - `EVAL_TRACE_HEADER`
  - `withEvalHeaders()`
- Parse incoming eval headers in gateway handlers.
- Pass headers through gateway router to downstream workers and auth-worker calls.

**Step 4: Re-run worker tests + typecheck**

Run: `cd workers/fantasy-mcp && npm test -- router.test.ts && npm run type-check`
Expected: PASS.

**Step 5: Commit**

```bash
cd workers/fantasy-mcp
git add ../shared/src/tracing.ts ../shared/src/index.ts src/index.ts src/router.ts src/mcp/tools.ts src/__tests__/router.test.ts
git commit -m "feat: propagate eval run/trace headers through fantasy gateway"
```

---

### Task 4: Structured Trace Logs In All Four Workers

**Files:**
- Modify: `workers/fantasy-mcp/src/index.ts`
- Modify: `workers/fantasy-mcp/src/mcp/tools.ts`
- Modify: `workers/espn-client/src/index.ts`
- Modify: `workers/yahoo-client/src/index.ts`
- Modify: `workers/auth-worker/src/index-hono.ts`
- Create: `workers/fantasy-mcp/src/logging.ts`
- Create: `workers/espn-client/src/logging.ts`
- Create: `workers/yahoo-client/src/logging.ts`
- Create: `workers/auth-worker/src/logging.ts`

**Step 1: Write failing tests for log payload shape (at least gateway)**

- Add/extend tests to validate emitted payload includes:
  - `trace_id`
  - `run_id`
  - `correlation_id`
  - `service`
  - `tool`
  - `phase`

**Step 2: Run tests to verify failure**

Run: `cd workers/fantasy-mcp && npm test -- tools.test.ts`
Expected: FAIL because structured logger is not wired.

**Step 3: Implement minimal structured log helper and use it**

- Replace free-form strings for eval-path logs with JSON objects.
- Gate detailed logs to eval traffic (`trace_id` present) to control noise.

**Step 4: Run per-worker typechecks/tests**

Run:
- `cd workers/fantasy-mcp && npm test && npm run type-check`
- `cd ../espn-client && npm test && npm run type-check`
- `cd ../yahoo-client && npm test && npm run type-check`
- `cd ../auth-worker && npm test && npm run type-check`

Expected: PASS.

**Step 5: Commit**

```bash
cd /Users/ggugger/Code/flaim
git add workers/fantasy-mcp/src workers/espn-client/src workers/yahoo-client/src workers/auth-worker/src workers/shared/src
git commit -m "feat: add structured trace logs across all workers"
```

---

### Task 5: Deterministic Log Enrichment For All Four Workers

**Files:**
- Modify: `../flaim-eval/src/cloudflare-logs.ts`
- Modify: `../flaim-eval/src/runner.ts`
- Create: `../flaim-eval/src/__tests__/cloudflare-logs.test.ts`

**Step 1: Write failing tests for query strategy**

- Test that collector:
  - queries all 4 workers
  - filters by `trace_id`
  - dedupes events
  - never cross-contaminates unrelated traces

**Step 2: Run tests to verify failure**

Run: `cd ../flaim-eval && node --import tsx --test src/__tests__/cloudflare-logs.test.ts`
Expected: FAIL because collector currently relies on partial message matching/time windows.

**Step 3: Implement collector update**

- Query each worker with trace filter first.
- Keep bounded retry for eventual consistency.
- Persist worker-specific files under trace directory:
  - `logs/fantasy-mcp.json`
  - `logs/espn-client.json`
  - `logs/yahoo-client.json`
  - `logs/auth-worker.json`

**Step 4: Run tests + real scenario validation**

Run:
- `cd ../flaim-eval && node --import tsx --test src/__tests__/cloudflare-logs.test.ts && npx tsc --noEmit`
- `npm run eval who_is_on_my_roster`

Expected: PASS and artifact contains worker log files for relevant workers.

**Step 5: Commit**

```bash
cd ../flaim-eval
git add src/cloudflare-logs.ts src/runner.ts src/__tests__/cloudflare-logs.test.ts
git commit -m "feat: deterministic per-trace log enrichment across all workers"
```

---

### Task 6: Add Re-Enrichment Command For Late-Indexed Logs

**Files:**
- Create: `../flaim-eval/src/enrich.ts`
- Modify: `../flaim-eval/package.json`
- Modify: `../flaim-eval/README.md`
- Create: `../flaim-eval/src/__tests__/enrich.test.ts`

**Step 1: Write failing test for re-enrich behavior**

- Given `run_id` + `trace_id`, command re-fetches logs and updates trace files without re-running LLM calls.

**Step 2: Run tests to verify failure**

Run: `cd ../flaim-eval && node --import tsx --test src/__tests__/enrich.test.ts`
Expected: FAIL because command does not exist.

**Step 3: Implement minimal CLI**

- Add `npm run enrich -- <run_id> [trace_id]`.
- Update only logs/ + trace metadata.

**Step 4: Verify manually**

Run:
- `cd ../flaim-eval && npm run enrich -- 2026-02-06T17-40-27Z`
- `cat runs/2026-02-06T17-40-27Z/*/trace.json`

Expected: existing traces updated with latest indexed logs.

**Step 5: Commit**

```bash
cd ../flaim-eval
git add src/enrich.ts package.json README.md src/__tests__/enrich.test.ts
git commit -m "feat: add post-run log re-enrichment command"
```

---

### Task 7: Documentation + Verification Checklist

**Files:**
- Modify: `docs/dev/mcp-eval-observability-scope.md`
- Modify: `docs/STATUS.md`
- Modify: `../flaim-eval/README.md`

**Step 1: Add trace contract docs**

- Define required headers and required log JSON fields.
- Define artifact directory layout and retention guidance.

**Step 2: Add runbook for failures**

- Empty logs, partial workers, delayed indexing, token permission issues.

**Step 3: Verify docs match implementation**

Run:
- `cd /Users/ggugger/Code/flaim && rg -n "X-Flaim-Eval-Trace|trace_id|re-enrich|workers observability" docs ../flaim-eval/README.md`
Expected: docs align with implemented paths and commands.

**Step 4: Commit**

```bash
cd /Users/ggugger/Code/flaim
git add docs/dev/mcp-eval-observability-scope.md docs/STATUS.md ../flaim-eval/README.md
git commit -m "docs: add per-trace observability contract and runbook"
```

---

### Task 8: End-to-End Acceptance Matrix (Manual)

**Files:**
- Create: `../flaim-eval/runs/<run_id>/acceptance-summary.json` (generated artifact)

**Step 1: Run multi-scenario eval**

Run: `cd ../flaim-eval && npm run eval`
Expected: all scenarios complete.

**Step 2: Validate per-trace isolation**

- No trace contains logs from unrelated scenario IDs.
- Log files are per worker and per trace directory.

**Step 3: Validate worker coverage**

- For scenarios touching ESPN: logs include `fantasy-mcp` + `espn-client` (+ auth when applicable).
- For Yahoo scenarios: logs include `fantasy-mcp` + `yahoo-client` (+ auth when applicable).

**Step 4: Capture acceptance summary**

- Record pass/fail for coverage, isolation, and latency overhead.

**Step 5: Final commit**

```bash
cd ../flaim-eval
git add runs/<run_id>/acceptance-summary.json
git commit -m "chore: add observability acceptance results for per-trace logging"
```

---

## Non-Goals (YAGNI)
- No distributed tracing backend migration.
- No automatic scoring/agent evaluator redesign.
- No non-Cloudflare observability ingestion in this phase.

## Rollout Notes
- Deploy worker changes to preview first; validate with `flaim-eval` pointed at preview MCP URL.
- Promote to production only after 3 consecutive runs show non-empty, per-trace isolated logs for expected workers.
