# Getting Started & Deployment Guide

This guide is the single source of truth for setting up, configuring, and deploying the FLAIM platform across all three environments: `dev` (local), `preview` (staging), and `prod` (production).

## What is FLAIM?

FLAIM (Fantasy League AI Manager) is your AI-powered fantasy sports assistant with modular authentication, usage limits, and multi-sport ESPN integration through MCP (Model Context Protocol) tools.

Instead of juggling multiple apps and spreadsheets, you can ask natural language questions like:
- *"How did my team perform this week?"*
- *"Who should I start at shortstop today?"*
- *"Analyze this trade proposal for me"*

---

## Quick Start (5 Minutes)

This will get you up and running with a local development environment.

```bash
# 1. Clone the repository
git clone https://github.com/yourusername/flaim
cd flaim

# 2. Install dependencies
npm install

# 3. Build all production artifacts (required once before first run)
./build.sh

# 4. Run the interactive launcher for local development
./start.sh
# ==> Choose Option 1 for 'dev' mode
```

After running `start.sh`, the script will guide you through creating a `openai/.env.local` file with the necessary environment variables.

### Prerequisites

Before you begin, ensure you have the following installed:

- **Node.js v20 (LTS)**: Required for consistent builds.
  - **Verification**: The `start.sh` script will automatically check your Node.js version and prompt you if it's incorrect. You can use a version manager like `nvm` (`nvm use 20`) to switch easily.
- **npm**: Comes bundled with Node.js.
- **Wrangler CLI**: The command-line tool for Cloudflare Workers.
  - **Installation**: `npm install -g wrangler`
  - **Verification**: The `start.sh` script will also check if a newer version of Wrangler is available and recommend updating.

---

## Deployment & Configuration

The `./start.sh` script is the primary tool for managing all environments.

### Environment Breakdown

FLAIM uses a three-environment architecture:

| Environment | `ENVIRONMENT` Var | `NODE_ENV`   | Description                                             |
| :---------- | :---------------- | :----------- | :------------------------------------------------------ |
| **`dev`**       | `dev`             | `development`| For local development, using local mock services.       |
| **`preview`**   | `preview`         | `production` | A remote staging environment with production-like security. |
| **`prod`**      | `prod`            | `production` | The live, public-facing application.                    |

### Environment Variables & Secrets

#### Local (`dev`)
- **File**: `openai/.env.local` (auto-generated by `start.sh`).
- **Variables**:
  ```bash
  ENVIRONMENT=dev
  OPENAI_API_KEY=sk-proj-your-openai-key
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your-clerk-key
  CLERK_SECRET_KEY=sk_test_your-clerk-secret
  CF_ENCRYPTION_KEY=your-32-byte-base64-key
  ```

#### Preview & Production (`preview` / `prod`)
- **Configuration**: Managed in the `env.preview` and `env.prod` blocks within each service's `wrangler.jsonc` file.
- **Secrets**: Must be set using the `wrangler secret put` command for each worker and environment.

First, generate a secure encryption key:
```bash
# Generate a secure 32-byte encryption key
openssl rand -base64 32
```

Then, set the secrets for each worker:
```bash
# Example: Set secrets for the auth-worker in the 'preview' environment
cd workers/auth-worker
wrangler secret put CF_ENCRYPTION_KEY --env preview
wrangler secret put CLERK_SECRET_KEY --env preview

# Repeat for other workers and the 'prod' environment as needed.
```

---

## Manual Deployment

While `start.sh` is recommended, you can deploy services manually if needed.

### Deploy Workers

```bash
# Navigate to the worker's directory
cd workers/auth-worker

# Deploy to the desired environment
wrangler deploy --env preview
# or
wrangler deploy --env prod
```

### Deploy Frontend (Cloudflare Pages)

The frontend uses `@cloudflare/next-on-pages` which creates a `.vercel/output` directory.

```bash
# Navigate to the frontend directory
cd openai

# Deploy to the 'preview' branch on Cloudflare Pages
wrangler pages deploy .vercel/output --project-name flaim-frontend --branch preview

# Deploy to the 'production' branch
wrangler pages deploy .vercel/output --project-name flaim-frontend --branch production
```

---

## Verification

After deployment, you can verify the services are running correctly using health checks.

```bash
# Local development
curl http://localhost:8787/health # auth-worker (check port from start.sh output)
curl http://localhost:3000        # frontend

# Preview environment (replace with your actual URLs)
curl https://auth-worker-dev.your-domain.workers.dev/health
curl https://preview.flaim.pages.dev

# Production
curl https://auth-worker.flaim.app/health
curl https://flaim.app
```

---

## FAQ & Troubleshooting

### Deployment & Build Issues

- **Why does the `start.sh` script check my Node.js version?**
  - The project requires **Node.js v20 (LTS)** for all development and builds. This ensures a consistent environment and prevents `EBADENGINE` warnings from `npm`. The `start.sh` script automatically verifies your version to prevent these issues. If it detects a mismatch, it will prompt you to switch using a tool like `nvm` (`nvm use 20`).

- **Why do I see a "git repo has uncommitted changes" warning during deployment?**
  - This is a standard warning from Wrangler. The `start.sh` script **handles this automatically** for you. It detects if your repository is "dirty" (has uncommitted changes) or if it's running in a CI environment and automatically appends the `--commit-dirty=true` flag to the deployment command. You can safely ignore this warning.

- **Why do I see a "Using edge runtime disables static generation" warning?**
  - This is expected behavior. FLAIM's API routes use `export const runtime = 'edge'` for Cloudflare compatibility and require dynamic execution for authentication and external API calls. This is not an error.

- **Why do I see an "npm warn Unknown cli config '--unsafe-perm'" warning?**
  - This is a known, temporary warning from an upstream dependency (`@cloudflare/next-on-pages`). It does not affect the build and will be resolved in a future update of the dependency.

### ESPN API

- **Why do we call `https://lm-api-reads.fantasy.espn.com` instead of the old `fantasy.espn.com/apis/v3` host?**
  - ESPN silently migrated its Fantasy front‑end to the **“League‑Manager API”** (`lm-api-reads`) in 2023‑24. The old host still resolves but increasingly returns 403s or HTML when you request private‑league data. All modern scrapers have switched to the new host.

- **What are the minimum headers required for the ESPN API?**
  ```text
  Cookie: SWID={uuid}; espn_s2={token}
  Accept: application/json
  X-Fantasy-Source: kona
  X-Fantasy-Platform: kona-web-2.0.0
  ```
  - **`SWID` / `espn_s2`**: User-specific cookies that are stored encrypted in Cloudflare KV.
  - **Kona headers**: Required by ESPN's edge servers to return JSON instead of HTML.

---

## Next Steps

1.  **Custom Domains**: See `docs/dev/FLAIM_APP_DOMAIN_MIGRATION.md` for production domain setup.
2.  **Monitoring**: Set up Cloudflare Analytics and Worker logs for your deployed services.
3.  **CI/CD**: Integrate `./build.sh` and `./start.sh` into your deployment pipeline. The scripts are CI-aware.