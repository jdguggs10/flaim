# Supabase Setup & Restoration Guide

Note: Application responses come from the OpenAI **Responses API** (not legacy chat completions).

This guide details how to set up the Supabase backend for FLAIM. Use this if you are setting up a new environment or restoring the project from scratch.

## 1. Create Supabase Project
1.  Go to [Supabase Dashboard](https://supabase.com/dashboard).
2.  Create a new project.
3.  Note your `Project URL` (e.g., `https://xyz.supabase.co`).
4.  Go to **Project Settings** > **API**.
5.  **Important (Post-May 2025):** Copy the **Secret Key** (`sb_secret_...`).
    *   *Note: Detailed usage of legacy `service_role` keys is deprecated. Use the Secret Key for `SUPABASE_SERVICE_KEY`.*

## 2. Database Schema
Run the following SQL in the [Supabase SQL Editor](https://supabase.com/dashboard/project/_/sql) to create the required tables and security policies.

```sql
-- Create espn_credentials table
CREATE TABLE IF NOT EXISTS public.espn_credentials (
    clerk_user_id TEXT PRIMARY KEY,
    swid TEXT NOT NULL,
    s2 TEXT NOT NULL,
    email TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- Create espn_leagues table
CREATE TABLE IF NOT EXISTS public.espn_leagues (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clerk_user_id TEXT NOT NULL,
    league_id TEXT NOT NULL,
    sport TEXT NOT NULL,
    team_id TEXT,
    team_name TEXT,
    league_name TEXT,
    season_year INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    UNIQUE(clerk_user_id, league_id, sport)
);

-- Enable RLS for security (Deny public access by default)
-- The auth-worker accesses these using the Service/Secret Key which bypasses RLS.
ALTER TABLE public.espn_credentials ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.espn_leagues ENABLE ROW LEVEL SECURITY;

-- Optional: Index for performance
CREATE INDEX IF NOT EXISTS idx_leagues_user ON public.espn_leagues(clerk_user_id);
```

## 3. Environment Configuration

### Local Development (`openai/.env.local`)
```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=sb_secret_...
```

### Cloudflare Deployment
You must set these secrets for both `preview` and `prod` environments if they change.

```bash
# Preview
echo "https://your-project.supabase.co" | npx wrangler secret put SUPABASE_URL --env preview --name auth-worker
echo "sb_secret_..." | npx wrangler secret put SUPABASE_SERVICE_KEY --env preview --name auth-worker

# Production
echo "https://your-project.supabase.co" | npx wrangler secret put SUPABASE_URL --env prod --name auth-worker
echo "sb_secret_..." | npx wrangler secret put SUPABASE_SERVICE_KEY --env prod --name auth-worker
```
