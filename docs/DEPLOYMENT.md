# FLAIM Deployment Guide

Complete deployment guide for all three environments: `dev` (local), `preview` (staging), and `prod` (production).

## üìã Prerequisites

Before deploying, ensure you have the following installed:

- **Node.js 20** (LTS) - Required for consistent builds
  - Install: `nvm install 20 && nvm use 20`
  - Verify: `node --version` (should show v20.x.x)
- **npm** (comes with Node.js)
- **Wrangler CLI** - Install with `npm install -g wrangler`

> **Note**: Using a different Node version will cause EBADENGINE warnings during builds. Always use Node 20 for development and deployment.

## üöÄ Quick Deploy

```bash
git clone https://github.com/yourusername/flaim
cd flaim

# 1. Switch to Node 20 (required)
nvm use 20

# 2. Build production artifacts
./build.sh

# 3. Deploy everything
./start.sh
```

Choose your deployment target in the interactive menu:
- **Option 1**: `dev` - Run locally for development
- **Option 2**: `preview` - Deploy to staging environment  
- **Option 3**: `prod` - Deploy to production

---

## üìã Environment Configuration

### Local Development (`dev`)

**Required Files:**
- `openai/.env.local` (auto-generated by `start.sh`)

**Required Variables:**
```bash
# OpenAI
OPENAI_API_KEY=sk-proj-your-openai-key

# Clerk Authentication  
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your-clerk-key
CLERK_SECRET_KEY=sk_test_your-clerk-secret

# Encryption for credentials
CF_ENCRYPTION_KEY=your-32-byte-base64-key

# Environment identifier
ENVIRONMENT=dev
```

**Worker URLs:** Automatically set to `http://localhost:8786/8787/8788`

### Preview Environment (`preview`)

**Configuration Source:** `wrangler.jsonc` files in each service directory

**Required Secrets** (set via `wrangler secret put`):
```bash
# For auth-worker
wrangler secret put CF_ENCRYPTION_KEY --env preview
wrangler secret put CLERK_SECRET_KEY --env preview

# Repeat for baseball-espn-mcp and football-espn-mcp workers
```

**Environment Variables** (defined in `wrangler.jsonc`):
- `ENVIRONMENT=preview`
- `NODE_ENV=production`
- Worker URLs point to `-dev` suffixed workers

### Production Environment (`prod`)

**Configuration Source:** `wrangler.jsonc` files (base environment + `env.prod`)

**Required Secrets** (set via `wrangler secret put`):
```bash
# For auth-worker  
wrangler secret put CF_ENCRYPTION_KEY --env prod
wrangler secret put CLERK_SECRET_KEY --env prod

# Repeat for all workers
```

**Environment Variables** (defined in `wrangler.jsonc`):
- `ENVIRONMENT=prod`
- `NODE_ENV=production`  
- Worker URLs point to production workers (no `-dev` suffix)

---

## üîê Required Secrets

### Generate Encryption Key
```bash
# Generate a secure 32-byte encryption key
openssl rand -base64 32
```

### Set Worker Secrets
```bash
# Navigate to each worker directory and set secrets
cd workers/auth-worker
wrangler secret put CF_ENCRYPTION_KEY --env preview
wrangler secret put CF_ENCRYPTION_KEY --env prod
wrangler secret put CLERK_SECRET_KEY --env preview  
wrangler secret put CLERK_SECRET_KEY --env prod

cd ../baseball-espn-mcp
wrangler secret put CF_ENCRYPTION_KEY --env preview
wrangler secret put CF_ENCRYPTION_KEY --env prod

cd ../football-espn-mcp  
wrangler secret put CF_ENCRYPTION_KEY --env preview
wrangler secret put CF_ENCRYPTION_KEY --env prod
```

---

## üìÅ Configuration Files

### `/workers/*/wrangler.jsonc`
Each worker has its own configuration file with three environments:

```jsonc
{
  "env": {
    "dev": {
      "vars": {
        "NODE_ENV": "development",
        "ENVIRONMENT": "dev"
      }
    },
    "preview": {
      "vars": {
        "NODE_ENV": "production", 
        "ENVIRONMENT": "preview"
      }
    },
    "prod": {
      "vars": {
        "NODE_ENV": "production",
        "ENVIRONMENT": "prod"  
      }
    }
  }
}
```

### `/openai/wrangler.jsonc`
Frontend configuration with environment-specific worker URLs:

```jsonc
{
  "vars": {
    "ENVIRONMENT": "prod",
    "NEXT_PUBLIC_AUTH_WORKER_URL": "https://auth-worker.your-domain.workers.dev"
  },
  "env": {
    "dev": {
      "vars": {
        "ENVIRONMENT": "dev",
        "NEXT_PUBLIC_AUTH_WORKER_URL": "http://localhost:8786"
      }
    },
    "preview": {
      "vars": {
        "ENVIRONMENT": "preview", 
        "NEXT_PUBLIC_AUTH_WORKER_URL": "https://auth-worker-dev.your-domain.workers.dev"
      }
    }
  }
}
```

### `/openai/.env.sample`
Template for local environment variables:

```bash
# Copy this to .env.local for local development
ENVIRONMENT=dev
OPENAI_API_KEY=your-openai-key
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your-clerk-publishable-key
CLERK_SECRET_KEY=your-clerk-secret-key
CF_ENCRYPTION_KEY=your-encryption-key
```

---

## üîß Manual Deployment

If you need to deploy manually without `start.sh`:

### Deploy Workers
```bash
# Deploy to preview
cd workers/auth-worker
wrangler deploy --env preview

# Deploy to production  
wrangler deploy --env prod
```

### Deploy Frontend
```bash
cd openai
# Deploy to Cloudflare Pages (Next-on-Pages)
# Build output directory is .vercel/output (NOT just /static)
# Always pass the dedicated Pages config so the Workers config isn‚Äôt mis-validated
wrangler pages deploy .vercel/output \
  --project-name flaim-frontend \
  --branch preview \
  --config openai/wrangler.pages.jsonc   # preview

wrangler pages deploy .vercel/output \
  --project-name flaim-frontend \
  --branch production \
  --config openai/wrangler.pages.jsonc   # prod
```

#### ‚ö†Ô∏è Why two Wrangler config files?
Cloudflare **Workers** and **Pages** parse the same `wrangler.*.json[c]` schema but have *different validators*:

* Pages accepts **only** `preview` and `production` env blocks and **rejects** a top-level `secrets` array.
* Workers happily allows custom env names (like `dev`) and a `secrets` list.

To keep both toolchains happy we store **two files** in `openai/`:

| File | Purpose |
|------|---------|
| `wrangler.workers.jsonc` | Used by the `auth-worker`, `*-mcp` workers, and any `wrangler deploy` command. Contains `dev/preview/prod` plus a `secrets` array. |
| `wrangler.jsonc` | Pages-only config (what you deployed above). Contains *only* `preview` and `production` env blocks and no secrets. |

The deploy flow therefore looks like:
1. `npx @cloudflare/next-on-pages` ‚áí builds `.vercel/output`.
2. `wrangler pages deploy ‚Ä¶` ‚áí reads **Pages** config (present in current dir).
3. Worker deploys (`wrangler deploy --env preview`) continue to read `wrangler.workers.jsonc`.

Keeping them separate prevents Pages validation errors without sacrificing the richer Workers config.
```

---

## ‚úÖ Verification

### Health Checks
```bash
# Local development
curl http://localhost:8786/health
curl http://localhost:3000

# Preview environment
curl https://auth-worker-dev.your-domain.workers.dev/health
curl https://dev.your-frontend.pages.dev

# Production  
curl https://auth-worker.your-domain.workers.dev/health
curl https://your-frontend.pages.dev
```

### Environment Variables Check
- **Dev**: Check browser console for correct localhost URLs
- **Preview/Prod**: Verify `ENVIRONMENT` variable in worker responses
- **All**: Confirm authentication flows work end-to-end

---

## üö® Common Issues

**Workers fail to deploy:**
- Verify secrets are set for the correct environment (`--env preview/prod`)
- Check `wrangler.jsonc` syntax and environment structure

**Frontend shows 500 errors:**
- Verify `NEXT_PUBLIC_*` URLs in `wrangler.jsonc` match deployed worker URLs
- Ensure `ENVIRONMENT` variable is set correctly

**Authentication failures:**
- Confirm `CLERK_SECRET_KEY` is set as a worker secret
- Verify Clerk publishable key matches between frontend and backend

**Credential storage errors:**
- Ensure `CF_ENCRYPTION_KEY` is identical across all workers
- Verify KV namespace is bound correctly in `wrangler.jsonc`

### Known Build Warnings

**EBADENGINE warnings during build:**
- **Cause**: Local Node.js version differs from project's `engines.node` specification
- **Solution**: Run `nvm use 20` to switch to Node 20 LTS before building
- **Impact**: No functional impact, just noisy logs

**"Using edge runtime disables static generation":**
- **Cause**: API routes use `export const runtime = 'edge'` for Cloudflare Pages compatibility
- **Solution**: Normal behavior for dynamic routes requiring auth/external API calls
- **Impact**: Pages render dynamically instead of statically (acceptable for API routes)

**"npm warn Unknown cli config '--unsafe-perm'":**
- **Cause**: Next-on-Pages uses deprecated npm flag during build process
- **Solution**: No action needed - upstream issue in `@cloudflare/next-on-pages`
- **Impact**: No functional impact, warning will be resolved in future npm/next-on-pages updates

**"git repo has uncommitted changes":**
- **Cause**: Wrangler warns when deploying from dirty git repository
- **Solution**: Commit changes before deployment, or use `CI=true` environment variable to auto-silence
- **Impact**: No functional impact, deployment proceeds normally

---

---

## üìù Recent Changes

### Build Script Improvements (2025-07-16)
- **CI Integration**: Added automatic `--commit-dirty=true` flag when `CI=true` environment is detected
- **Node Version Documentation**: Added Prerequisites section emphasizing Node 20 LTS requirement
- **Warning Documentation**: Expanded Known Build Warnings section with comprehensive explanations
- **Developer Experience**: Enhanced Quick Deploy instructions with Node version switching

---

## üìö Next Steps

1. **Custom Domains**: See `docs/dev/FLAIM_APP_DOMAIN_MIGRATION.md` for production domain setup
2. **Monitoring**: Set up Cloudflare Analytics and Worker logs
3. **CI/CD**: Integrate `./build.sh` and `./start.sh` into your deployment pipeline